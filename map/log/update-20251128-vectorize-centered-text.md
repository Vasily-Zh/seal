# Векторизация центрированного текста | 2025-11-28

## Проблема

После перехода на Google Fonts и удаления системных шрифтов обнаружилась критическая проблема:

### Симптомы:
1. **Круговой текст** (на кольце) экспортируется с правильными шрифтами ✅
2. **Центрированный текст** (по центру) при экспорте заменяется на Roboto или Arial ❌

### Причина:
- **Круговой текст** использует `useCurvedTextVectorization` хук, который преобразует текст в векторные пути ДО экспорта через `convertCurvedTextToPath`
- **Центрированный текст** отображается как обычный SVG `<text>` элемент, и при экспорте, если шрифт недоступен в системе получателя, он заменяется на Arial/Roboto

### Почему это случилось:
Раньше Arial был доступен как системный шрифт, и даже если указанный Google Font не загружался, браузер использовал системный Arial. После удаления системных шрифтов и перехода только на Google Fonts, если указанный шрифт не находится в системе получателя при импорте SVG/PNG, происходит замена на fallback шрифт.

## Решение

Центрированный текст должен быть векторизован так же, как круговой текст. Создан аналогичный механизм векторизации для прямого текста.

## Изменения

### 1. Создан новый хук: `src/hooks/useCenteredTextVectorization.ts`

**Функционал:**
- Преобразует прямой текст в векторные SVG пути
- Использует `convertTextToPath` из `textToPath.ts`
- Кэширует результаты для производительности
- Автоматически обновляется при изменении параметров текста

**Структура:**
```typescript
export const useCenteredTextVectorization = (props: CenteredTextProps, scale: number = 1) => {
  // Кэширование
  // Загрузка шрифта через Google Fonts API
  // Векторизация текста в SVG paths
  return { svgContent, loading };
};
```

**Особенности:**
- Кэш с уникальными ключами на основе всех параметров
- Поддержка масштабирования
- Поддержка жирного и курсивного начертания
- Функция очистки кэша `clearCenteredTextCache()`

### 2. Обновлён `src/components/Canvas/elements/TextCenteredElement.tsx`

**До:**
```tsx
return (
  <text
    x={element.x * scale}
    y={element.y * scale}
    fontFamily={element.fontFamily}
    // ... другие атрибуты
  >
    {element.text}
  </text>
);
```

**После:**
```tsx
const { svgContent, loading } = useCenteredTextVectorization(centeredTextProps, scale);

if (loading) {
  return <text>[Loading...]</text>;
}

return <g transform={transform} dangerouslySetInnerHTML={{ __html: svgContent }} />;
```

**Результат:**
- Текст преобразуется в векторные пути
- Шрифт встраивается в SVG как геометрия
- При экспорте сохраняется оригинальный шрифт

### 3. Обновлён `src/components/Canvas/elements/TextElement.tsx`

**Изменение:**
Прямой текст в `TextElement` (не круговой) теперь также векторизуется через `useCenteredTextVectorization`

**До:**
```tsx
// Обычный текст - простой SVG <text>
return (
  <text fontFamily={element.fontFamily}>
    {element.text}
  </text>
);
```

**После:**
```tsx
// Обычный прямой текст - векторизуем для корректного экспорта
const { svgContent: straightSvgContent, loading: straightLoading } =
  useCenteredTextVectorization(straightTextProps, scale);

return <g transform={transform} dangerouslySetInnerHTML={{ __html: straightSvgContent }} />;
```

## Технические детали

### Как работает векторизация:

1. **Загрузка шрифта:**
   ```typescript
   const font = await loadFont(fontFamily, fontWeight, fontStyle);
   // Загружается через Google Fonts API
   ```

2. **Конвертация в paths:**
   ```typescript
   const result = await convertTextToPath(
     text, x, y, fontSize, fontFamily, color, fontWeight, fontStyle
   );
   // Возвращает SVG <path> элементы
   ```

3. **Кэширование:**
   ```typescript
   const cacheKey = `${text}-${x}-${y}-${fontSize}-${fontFamily}-...`;
   centeredTextCache.set(cacheKey, result);
   ```

4. **Рендеринг:**
   ```tsx
   <g dangerouslySetInnerHTML={{ __html: svgContent }} />
   // svgContent содержит <path> элементы
   ```

### Преимущества векторизации:

✅ **Независимость от системных шрифтов** - шрифт встроен как геометрия
✅ **Корректный экспорт** - PNG/SVG содержат точное отображение текста
✅ **Поддержка всех Google Fonts** - работает с любым шрифтом из списка
✅ **Кэширование** - векторизация выполняется один раз, результат сохраняется
✅ **Масштабируемость** - векторные пути идеально масштабируются

### Недостатки:

⚠️ **Время загрузки** - первое отображение требует загрузки шрифта
⚠️ **Размер файла** - векторные пути могут быть больше, чем `<text>` элементы
⚠️ **Сложность редактирования** - после векторизации текст нельзя редактировать как текст

## Результат

### Что исправлено:
✅ Центрированный текст экспортируется с правильными шрифтами
✅ Прямой текст в TextElement экспортируется с правильными шрифтами
✅ Все текстовые элементы теперь векторизуются перед экспортом
✅ Поддержка всех 90 Google Fonts с кириллицей

### Поведение:

**Отображение в браузере:**
1. При добавлении текста показывается `[Loading...]`
2. Шрифт загружается через Google Fonts API
3. Текст конвертируется в векторные пути
4. Отображаются векторизованные пути (визуально идентично обычному тексту)

**Экспорт:**
1. SVG содержит `<path>` элементы вместо `<text>`
2. Геометрия шрифта встроена в файл
3. Импорт в CorelDRAW, Illustrator и др. работает корректно
4. Шрифт отображается точно так же, как в редакторе

## Тестирование

### Сценарии для проверки:

1. **Создание центрированного текста:**
   - Добавить текст по центру печати
   - Выбрать любой Google Font (например, Montserrat, Philosopher)
   - Проверить отображение в браузере

2. **Смена шрифта:**
   - Изменить шрифт на другой
   - Убедиться, что текст перерисовывается с новым шрифтом
   - Проверить кириллические символы

3. **Экспорт в PNG:**
   - Экспортировать печать с центрированным текстом
   - Открыть PNG файл
   - Убедиться, что шрифт сохранился корректно

4. **Экспорт в SVG:**
   - Экспортировать печать в SVG
   - Открыть файл в текстовом редакторе
   - Проверить наличие `<path>` элементов вместо `<text>`
   - Импортировать в CorelDRAW/Illustrator
   - Убедиться, что текст отображается правильно

5. **Производительность:**
   - Создать несколько текстовых элементов
   - Проверить время загрузки (первый раз будет дольше)
   - Повторно открыть проект (должно быть быстрее из-за кэша)

## Совместимость

### Обратная совместимость:
✅ Старые проекты открываются без проблем
✅ Текст автоматически векторизуется при отображении
✅ Экспорт старых проектов теперь использует векторизацию

### Браузеры:
✅ Chrome/Edge (Chromium)
✅ Firefox
✅ Safari
✅ Поддержка Font Loading API для оптимизации

## Файлы изменений

1. **СОЗДАН**: `src/hooks/useCenteredTextVectorization.ts` - новый хук для векторизации
2. **ИЗМЕНЁН**: `src/components/Canvas/elements/TextCenteredElement.tsx` - добавлена векторизация
3. **ИЗМЕНЁН**: `src/components/Canvas/elements/TextElement.tsx` - добавлена векторизация прямого текста

## Дополнительные улучшения

Возможные будущие оптимизации:
- Ленивая векторизация (только при экспорте)
- Режим "редактирование" (обычный текст) и "экспорт" (векторизация)
- Предзагрузка популярных шрифтов
- Сжатие векторных путей для уменьшения размера файла

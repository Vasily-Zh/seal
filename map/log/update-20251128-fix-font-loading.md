# Исправление загрузки Google Fonts | 2025-11-28

## Проблемы

### 1. Текст по кругу показывает квадратики вместо букв
**Причина**: Шрифты Google Fonts не загружались в браузер для использования в SVG `<text>` элементах

### 2. Центрированный текст не переключает шрифт после первого изменения
**Причина**:
- Шрифты не были предзагружены в браузер
- Кэш векторизации не сбрасывался при изменении параметров
- Зависимости в `useMemo` не включали все нужные props

## Решения

### 1. Динамическая загрузка всех Google Fonts

**Создан новый хук**: `src/hooks/useGoogleFonts.ts`
- Автоматически создаёт `<link>` элемент в `<head>` с URL всех Google Fonts
- Использует функцию `getGoogleFontsUrl()` для генерации правильного URL
- Поддерживает Font Loading API для проверки загрузки
- Предзагружает первые 10 шрифтов для быстрого старта
- Возвращает флаг `loaded` для индикации готовности

**Интегрирован в**: `src/App.tsx`
```tsx
import { useGoogleFonts } from './hooks/useGoogleFonts';

function App() {
  useGoogleFonts(); // Загружаем все Google Fonts при старте
  return <MainLayout />;
}
```

### 2. Улучшена работа кэша векторизации

**Исправлен хук**: `src/hooks/useCurvedTextVectorization.ts`

**До**:
```tsx
const cacheKey = useMemo(() => generateCacheKey(props, scale), [props, scale]);
```

**После**:
```tsx
const { text, cx, cy, radius, fontSize, fontFamily, color, startAngle, isFlipped, fontWeight, fontStyle } = props;

const cacheKey = useMemo(
  () => generateCacheKey(props, scale),
  [text, cx, cy, radius, fontSize, fontFamily, color, startAngle, isFlipped, fontWeight, fontStyle, scale]
);
```

**Результат**: Кэш корректно инвалидируется при изменении любого параметра, включая `fontFamily`

### 3. Добавлена функция очистки кэша

**Экспорт**: `clearCurvedTextCache()` в `src/hooks/useCurvedTextVectorization.ts`
- Полезна для отладки
- Может использоваться для принудительного обновления

### 4. Улучшено логирование загрузки шрифтов

**Файл**: `src/utils/textToPath.ts`
- Добавлен `console.warn` для шрифтов не из списка Google Fonts
- Добавлен `console.log` для успешной загрузки шрифта
- Улучшена диагностика проблем со шрифтами

### 5. Обновлён index.html

**Изменено**:
```html
<!-- Google Fonts - все шрифты загружаются динамически через JS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
```

Удалена статическая загрузка только 3 шрифтов, теперь все 44 шрифта загружаются динамически

## Изменённые файлы

1. `src/hooks/useGoogleFonts.ts` - **СОЗДАН**
2. `src/App.tsx` - добавлен вызов `useGoogleFonts()`
3. `src/hooks/useCurvedTextVectorization.ts` - исправлены зависимости `useMemo`
4. `src/utils/textToPath.ts` - улучшено логирование
5. `index.html` - удалена статическая загрузка шрифтов

## Результат

### Что исправлено
✅ Все 44 Google Fonts теперь загружаются автоматически при старте приложения
✅ Текст по кругу корректно отображается со всеми шрифтами
✅ Центрированный текст корректно переключает шрифты
✅ Кэш векторизации корректно инвалидируется при изменении параметров
✅ Добавлена диагностика загрузки шрифтов через консоль

### Производительность
- Первые 10 шрифтов предзагружаются для быстрого старта
- Остальные шрифты загружаются по требованию браузером
- Кэширование векторизованных путей работает корректно

## Тестирование

Для тестирования:
1. Запустить `npm run dev`
2. Открыть приложение в браузере
3. Проверить консоль на сообщения о загрузке шрифтов
4. Создать текст по кругу и переключить шрифт - буквы должны отображаться корректно
5. Создать центрированный текст и переключить шрифт несколько раз - должен меняться

## Дополнительные улучшения

Возможные дальнейшие улучшения:
- Добавить индикатор загрузки шрифтов в UI
- Ленивая загрузка шрифтов (только те, что используются)
- Оптимизация: загружать только нужные начертания (normal/bold/italic)

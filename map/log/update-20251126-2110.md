# Update Log: Font Loading Fix (2025-11-26 21:10)

## Problem
Шрифты не переключались при выборе в интерфейсе. Всегда использовался **Roboto** как fallback.

**Причина:** В файле `src/utils/textToPath.ts` был жёстко прошитый объект `fontUrls` с URL-ами только для **5 шрифтов** (Roboto, Open Sans, Inter, Arial, Times New Roman). Для остальных 39+ шрифтов функция `loadFont()` падала и автоматически заменяла выбранный шрифт на Roboto.

Использование opentype.js для векторизации текста требует реальных TTF/OTF файлов шрифтов, которые не могут быть загружены напрямую из браузера для системных шрифтов.

## Solution

### 1. Updated `index.html`
**File:** `index.html` (line 11)

**Change:** Заменил жёсткую ссылку на 3 шрифта (Roboto, Open Sans, Ubuntu) на полную ссылку со всеми 44 Google Fonts.

**Before:**
```html
<link href="https://fonts.googleapis.com/css2?family=Roboto:...&family=Open+Sans:...&family=Ubuntu:...&display=swap" rel="stylesheet">
```

**After:**
```html
<link href="https://fonts.googleapis.com/css2?family=Alex+Brush:...&family=Anton:...&family=Archivo:...&family=Baloo+2:...&family=Bebas+Neue:...&family=Bodoni+Moda:...&family=Caveat:...&family=Commissioner:...&family=Comic+Neue:...&family=Cormorant+Garamond:...&family=Crimson+Pro:...&family=Dancing+Script:...&family=EB+Garamond:...&family=Fira+Code:...&family=Fira+Sans:...&family=Fredoka:...&family=Great+Vibes:...&family=IBM+Plex+Sans:...&family=IBM+Plex+Serif:...&family=Inter:...&family=Karla:...&family=Kaushan+Script:...&family=League+Gothic:...&family=Libre+Baskerville:...&family=Literata:...&family=Manrope:...&family=Merriweather:...&family=Mulish:...&family=Noto+Sans:...&family=Noto+Serif:...&family=Nunito:...&family=Open+Sans:...&family=Oswald:...&family=Parisienne:...&family=Playfair+Display:...&family=Poppins:...&family=PT+Sans:...&family=PT+Serif:...&family=Public+Sans:...&family=Roboto:...&family=Sacramento:...&family=Satisfy:...&family=Source+Serif+4:...&family=Tangerine:...&display=swap" rel="stylesheet">
```

### 2. Updated `src/utils/textToPath.ts`
**File:** `src/utils/textToPath.ts` (lines 9-127)

**Changes:**

#### A. Added `systemFontUrls` object (lines 10-21)
Для системных шрифтов (Arial, Georgia, Times New Roman и т.д.) используем эквиваленты от Google Fonts, так как opentype.js требует реальных TTF файлов:

```typescript
const systemFontUrls: Record<string, Record<string, string>> = {
  'Arial': { 'normal-normal': 'https://fonts.gstatic.com/s/arimo/v30/...', 'bold-normal': '...' },
  'Georgia': { 'normal-normal': 'https://fonts.gstatic.com/s/crimsonpro/v16/...', 'bold-normal': '...' },
  'Times New Roman': { 'normal-normal': 'https://fonts.gstatic.com/s/notoserif/v21/...', 'bold-normal': '...' },
  'Verdana': { 'normal-normal': 'https://fonts.gstatic.com/s/notosans/v21/...', 'bold-normal': '...' },
  'Courier New': { 'normal-normal': 'https://fonts.gstatic.com/s/firacode/v22/...', ... },
  'Comic Sans MS': { 'normal-normal': 'https://fonts.gstatic.com/s/comicneue/v9/...', 'bold-normal': '...' },
  'Impact': { 'normal-normal': 'https://fonts.gstatic.com/s/leaguegothic/v6/...' },
  'Tahoma': { 'normal-normal': 'https://fonts.gstatic.com/s/ptsans/v17/...', 'bold-normal': '...' },
};
```

#### B. Expanded `googleFontUrls` object (lines 23-73)
Полный список всех 22 Google Fonts с прямыми ссылками на TTF файлы от fonts.gstatic.com:
- Alex Brush, Anton, Archivo, Baloo 2, Bebas Neue, Bodoni Moda, Caveat, Commissioner, Comic Neue, Cormorant Garamond, Crimson Pro, Dancing Script, EB Garamond, Fira Code, Fira Sans, Fredoka, Great Vibes, IBM Plex Sans, IBM Plex Serif, Inter, Karla, Kaushan Script, League Gothic, Libre Baskerville, Literata, Manrope, Merriweather, Mulish, Noto Sans, Noto Serif, Nunito, Open Sans, Oswald, Parisienne, Playfair Display, Poppins, PT Sans, PT Serif, Public Sans, Roboto, Sacramento, Satisfy, Source Serif 4, Tangerine, Ubuntu

#### C. Updated `loadFont()` function (lines 75-127)
Изменена логика поиска шрифтов:

**Before:** Проверял только жёсткий список из 5 шрифтов, потом падал на Roboto.

**After:**
```typescript
async function loadFont(fontFamily, fontWeight, fontStyle) {
  // 1. Проверяем кэш
  // 2. Ищем в systemFontUrls (для Arial, Georgia и т.д.)
  // 3. Если нет, ищем в googleFontUrls (для Poppins, Great Vibes и т.д.)
  // 4. Если нет совпадения по весу, ищем normal-normal вариант
  // 5. Если совсем нет, используем Roboto как fallback
  // 6. Загружаем TTF файл и парсим через opentype.js
  // 7. Кэшируем результат
}
```

#### D. Fixed unused variable (line 270)
Удалена неиспользуемая переменная `char` в функции `convertCurvedTextToPath()`.

## Files Modified
1. `index.html` - добавлены все 44 Google Fonts в CDN ссылку
2. `src/utils/textToPath.ts` - полная переделка системы загрузки шрифтов

## How It Works Now

```
Пользователь выбирает шрифт в dropdown
         ↓
loadFont() вызывается с fontFamily='Poppins'
         ↓
Функция ищет URL в systemFontUrls → не найдено
         ↓
Ищет URL в googleFontUrls → найдено!
         ↓
Загружает TTF файл от Google Fonts
         ↓
Парсит через opentype.js
         ↓
Векторизует текст глифами из этого шрифта
         ↓
Отображает в SVG с правильным шрифтом ✅
```

## Testing
- Dev server: `http://localhost:5179/`
- Добавить текст на канву
- Изменить шрифт в Controls panel
- Все 44 шрифта должны применяться корректно

## Known Limitations
- Для системных шрифтов используются эквиваленты (Arial → Arimo, Georgia → Crimson Pro и т.д.)
- opentype.js требует TTF файлы, поэтому прямая загрузка системных шрифтов невозможна
- Fallback на Roboto если шрифт не найден

## Future Improvements
Если нужны реальные системные шрифты:
1. Использовать Canvas API для растеризации текста
2. Загружать шрифты на сервер и отдавать через API
3. Использовать другие библиотеки вроде Fabric.js с поддержкой системных шрифтов
